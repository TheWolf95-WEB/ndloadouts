<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ NDHQ</title>
  <style>
    body {
      margin: 0;
      background-color: #0f111a;
      font-family: 'Rubik', 'Segoe UI', sans-serif;
      color: #ffffff;
    }
    header {
      text-align: center;
      padding: 20px;
      background: #171d25;
      border-bottom: 2px solid #2a3545;
    }
    header h1 {
      font-size: 22px;
      margin: 0;
      color: #00ffcc;
    }
    header p {
      font-size: 14px;
      color: #aaa;
      margin: 5px 0 0;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 15px;
    }
    h2 {
      font-size: 18px;
      margin: 20px 0 10px;
      color: #00ccff;
      display: flex;
      align-items: center;
    }
    h2 span {
      margin-right: 8px;
    }
    .card {
      background: #171d25;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
      padding: 15px;
      margin-bottom: 25px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 600px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #2a3545;
      word-break: break-word;
    }
    th {
      background: #1c222d;
      color: #00ffcc;
      font-weight: 600;
    }
    tr:hover {
      background: #223044;
    }
    footer {
      text-align: center;
      padding: 15px;
      color: #777;
      font-size: 13px;
      border-top: 1px solid #2a3545;
      margin-top: 30px;
    }
    @media (max-width: 600px) {
      th, td {
        font-size: 13px;
        padding: 8px;
      }
    }
  </style>
  <script>
    async function loadData() {
      try {
        // === –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ===
        const res = await fetch("/api/analytics/latest");
        const data = await res.json();

        const onlineBody = document.getElementById("online-body");
        const offlineBody = document.getElementById("offline-body");
        onlineBody.innerHTML = "";
        offlineBody.innerHTML = "";

        let hasOnline = false;
        let hasOffline = false;

        data.analytics.forEach(row => {
          const tr = `
            <tr>
              <td>${row.user}</td>
              <td>${row.action}</td>
              <td>${row.platform}</td>
              <td>${row.status}</td>
              <td>${row.time}</td>
            </tr>
          `;
          if (row.status.includes("–û–Ω–ª–∞–π–Ω")) {
            onlineBody.innerHTML += tr;
            hasOnline = true;
          } else {
            offlineBody.innerHTML += tr;
            hasOffline = true;
          }
        });

        if (!hasOnline) {
          onlineBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">–ù–µ—Ç –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>`;
        }
        if (!hasOffline) {
          offlineBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777">–ù–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>`;
        }

        // === –û—à–∏–±–∫–∏ ===
        const errRes = await fetch("/api/analytics/errors");
        const errData = await errRes.json();

        const errorsBody = document.getElementById("errors-body");
        errorsBody.innerHTML = "";

        if (errData.errors && errData.errors.length > 0) {
          errData.errors.forEach(row => {
            let detailsHtml = "";
        
            try {
              const details = typeof row.details === "string" ? JSON.parse(row.details) : row.details;
              if (details && typeof details === "object") {
                detailsHtml = Object.entries(details)
                  .map(([k, v]) => `<div><b>${k}:</b> ${v}</div>`)
                  .join("");
              } else {
                detailsHtml = row.details || "-";
              }
            } catch {
              detailsHtml = row.details || "-";
            }
        
            errorsBody.innerHTML += `
              <tr>
                <td>${row.user}</td>
                <td style="color:#ff5555">${row.error}</td>
                <td style="color:#ccc">${detailsHtml}</td>
                <td style="color:#00ccff">${row.time}</td>
              </tr>
            `;
          });
        } else {
          errorsBody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#777">–û—à–∏–±–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>`;
        }


        document.getElementById("last-update").textContent =
          "‚è± –û–±–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:", e);
      }
    }

    setInterval(loadData, 10000);
    window.onload = loadData;
  </script>
</head>
<body>
  <header>
    <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π NDHQ</h1>
    <p id="last-update">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  </header>

  <div class="container">
    <!-- –û–Ω–ª–∞–π–Ω -->
    <h2><span>üü¢</span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–í—Ä–µ–º—è</th>
          </tr>
        </thead>
        <tbody id="online-body"></tbody>
      </table>
    </div>

    <!-- –û—Ñ—Ñ–ª–∞–π–Ω -->
    <h2><span>‚ö™</span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ñ—Ñ–ª–∞–π–Ω</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤ —Å–µ—Ç–∏</th>
          </tr>
        </thead>
        <tbody id="offline-body"></tbody>
      </table>
    </div>

    <!-- –û—à–∏–±–∫–∏ -->
    <h2><span>‚ö†Ô∏è</span>–û—à–∏–±–∫–∏</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–û—à–∏–±–∫–∞</th>
            <th>–î–µ—Ç–∞–ª–∏</th>
            <th>–í—Ä–µ–º—è</th>
          </tr>
        </thead>
        <tbody id="errors-body"></tbody>
      </table>
    </div>
  </div>

  <footer>
    NDHQ ¬© 2025 ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
  </footer>
</body>
</html>
